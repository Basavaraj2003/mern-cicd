pipeline {
    agent any

    tools {
        nodejs 'NodeJS22'
    }

    environment {
        DOCKER_IMAGE_CLIENT = 'mern-client'
        DOCKER_IMAGE_SERVER = 'mern-server'
        DOCKER_TAG = "${BUILD_NUMBER}"
        SONAR_HOST_URL = 'http://sonarqube:9000'
        SONAR_TOKEN = credentials('sonar-token')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/Basavaraj2003/mern-cicd.git'
                    ]]
                ])
            }
        }

        stage('Verify Node Installation') {
            steps {
                sh 'npm --version'
                sh 'node --version'
            }
        }

        stage('Fix ESLint Configuration') {
            steps {
                dir('client') {
                    script {
                        sh '''
                            echo "Creating ESLint configuration..."
                            cat > .eslintrc.cjs << 'EOL'
module.exports = {
    root: true,
    env: {
        browser: true,
        es2021: true,
        node: true
    },
    extends: [
        "eslint:recommended",
        "plugin:react/recommended",
        "plugin:@typescript-eslint/recommended"
    ],
    parser: "@typescript-eslint/parser",
    parserOptions: {
        ecmaFeatures: {
            jsx: true
        },
        ecmaVersion: "latest",
        sourceType: "module"
    },
    plugins: [
        "react",
        "@typescript-eslint"
    ],
    rules: {
        "react/react-in-jsx-scope": "off"
    },
    settings: {
        react: {
            version: "detect"
        }
    }
}
EOL
                            echo "ESLint configuration created"
                            ls -la .eslintrc.cjs
                        '''
                    }
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                dir('client') {
                    sh '''
                        echo "Cleaning up existing installations..."
                        rm -rf node_modules package-lock.json

                        echo "Cleaning npm cache..."
                        npm cache clean --force

                        echo "Installing dependencies (including devDependencies)..."
                        npm install --legacy-peer-deps --include=dev

                        echo "Verifying Vite installation..."
                        ls -la node_modules/vite
                        npm ls vite
                    '''
                }

                dir('server') {
                    sh '''
                        echo "Cleaning up existing installations..."
                        rm -rf node_modules package-lock.json

                        echo "Cleaning npm cache..."
                        npm cache clean --force

                        echo "Installing dependencies..."
                        npm install --legacy-peer-deps
                    '''
                }
            }
        }

        stage('Create Vite Config') {
            steps {
                dir('client') {
                    sh '''
                        echo "Creating Vite configuration..."
                        cat > vite.config.js << 'EOL'
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  build: {
    outDir: 'dist',
    assetsDir: 'assets'
  },
  resolve: {
    alias: {
      '@': '/src'
    }
  }
})
EOL
                        echo "Vite configuration created"
                        ls -la vite.config.js
                    '''
                }
            }
        }

        stage('Lint') {
            steps {
                dir('client') {
                    sh '''
                        echo "Running ESLint for client..."
                        # Ensure a 'lint' script exists in client/package.json
                        npm run lint -- --fix
                    '''
                }

                dir('server') {
                    sh '''
                        echo "Running lint for server..."
                        # Ensure a 'lint' script exists in server/package.json
                        npm run lint -- --fix
                    '''
                }
            }
        }

        stage('Build') {
            steps {
                dir('client') {
                    sh '''
                        echo "Current directory: $(pwd)"
                        echo "Directory contents:"
                        ls -la

                        echo "Building with Vite..."
                        npm run build
                    '''
                }
            }
        }

        stage('Test') {
            steps {
                dir('client') {
                    echo "Starting Client Tests (Unit/Component)..."
                    sh 'npm test' // Runs Vitest as configured in package.json
                }
                dir('server') {
                    echo "Starting Server Unit Tests..."
                    sh 'npm run test:unit' // Runs Jest for unit tests
                    echo "Starting Server Integration Tests..."
                    sh 'npm run test:integration' // Runs Jest for integration tests
                }
            }
        }

        stage('Build Docker Images') {
            steps {
                dir('client') {
                    sh '''
                        echo "Building client Docker image..."
                        docker build -t ${DOCKER_IMAGE_CLIENT}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE_CLIENT}:${DOCKER_TAG} ${DOCKER_IMAGE_CLIENT}:latest
                    '''
                }

                dir('server') {
                    sh '''
                        echo "Building server Docker image..."
                        docker build -t ${DOCKER_IMAGE_SERVER}:${DOCKER_TAG} .
                        docker tag ${DOCKER_IMAGE_SERVER}:${DOCKER_TAG} ${DOCKER_IMAGE_SERVER}:latest
                    '''
                }
            }
        }

        stage('Release Docker Images') {
            steps {
                script {
                    echo "Pushing Docker images to registry..."
                    // Add Jenkins credentials for your Docker registry
                    sh "docker push ${DOCKER_IMAGE_CLIENT}:${DOCKER_TAG}"
                    sh "docker push ${DOCKER_IMAGE_CLIENT}:latest"
                    sh "docker push ${DOCKER_IMAGE_SERVER}:${DOCKER_TAG}"
                    sh "docker push ${DOCKER_IMAGE_SERVER}:latest"
                    echo "Docker images pushed."
                }
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                    echo "Stopping existing containers..."
                    docker-compose down || true

                    echo "Starting new containers..."
                    docker-compose up -d

                    // Add health checks here to ensure services are running before proceeding
                    echo "Waiting for client service to be healthy..."
                    sh 'curl --fail --silent --show-error http://localhost:3000 || exit 1' // Example health check for client
                    echo "Client service is healthy."

                    echo "Waiting for server service to be healthy..."
                    sh 'curl --fail --silent --show-error http://localhost:3002/api/health || exit 1' // Example health check for server
                    echo "Server service is healthy."

                    echo "Checking container status..."
                    docker-compose ps

                    echo "Checking container logs..."
                    docker-compose logs --tail=50
                '''
            }
        }

        stage('Monitor') {
            steps {
                script {
                    echo "Monitoring stage: Placeholder for integrating with external monitoring systems or adding monitoring-specific checks."
                    // Add commands here to configure monitoring dashboards, set up alerts, etc.
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    withSonarQubeEnv('SonarQube') {
                        sh '''
                            echo "Running SonarQube analysis..."
                            sonar-scanner \
                                -Dsonar.projectKey=mern-jenkins \
                                -Dsonar.sources=. \
                                -Dsonar.exclusions=node_modules/,/node_modules/,/dist/,/build/,/.git/,/.github/** \
                                -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info
                        '''
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                timeout(time: 1, unit: 'HOURS') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline succeeded!'
            sh '''
                echo "Deployment completed successfully!"
                echo "Frontend is available at: http://localhost:3000"
                echo "Backend is available at: http://localhost:3002"
            '''
        }
        failure {
            echo 'Pipeline failed!'
            script {
                node {
                    sh '''
                        echo "Deployment failed! Rolling back..."
                        docker-compose -f docker-compose.yml down
                    '''
                }
            }
        }
        always {
            script {
                node {
                    cleanWs()
                }
            }
        }
    }
}
